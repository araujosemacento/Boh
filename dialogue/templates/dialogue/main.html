{% extends 'dialogue/base.html' %}
{% load static %}

{% block content %}
  <div class="boh-display">
    <div class="expression" id="boh-expression">[ ▀ ¸ ▀]</div>
    <div class="dialogue-container">
      <span class="dialogue-prefix">──┤</span>
      <span class="dialogue-text" id="dialogue-text"></span>
      <span class="dialogue-suffix">│</span>
    </div>
  </div>

  <!-- Área para exibir conteúdo estático -->
  <div class="static-text" id="static-display" style="display: none;"></div>
  <!-- Área para exibir diagramas ASCII (listas e AUX) -->
  <div class="list-model" id="ascii-display" style="display: none;"></div>

  <!-- Área para exibir arte do personagem AUX -->
  <div class="aux-display" id="aux-display" style="display: none;"></div>

  <!-- Área de input para respostas S/N -->
  <div class="input-area" id="response-area" style="display: none;">
    <div class="input-options">
      <button class="control-btn" id="yes-btn" onclick="sendResponse('positive')"><span class="text-green">S</span>im</button>
      <button class="control-btn" id="no-btn" onclick="sendResponse('negative')"><span class="text-red">N</span>ão</button>
    </div>
  </div>

  <!-- Área de input para nome do usuário (criada dinamicamente) -->
  <div class="input-area" id="name-input" style="display: none;"></div>
  <!-- Área de debug/controles para testes -->
  {% if settings.DEBUG %}
    <div id="debug-panel" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #0f0;">
      <h4 style="color: #0f0; margin: 0 0 10px 0;">Debug Controls</h4>
      <button onclick="bohDialogue.reset()" style="margin: 2px; padding: 5px; background: #333; color: #0f0; border: 1px solid #0f0;">Reset</button>
      <button onclick="testBasicText()" style="margin: 2px; padding: 5px; background: #333; color: #0f0; border: 1px solid #0f0;">Test Text</button>
      <button onclick="testTypewriter()" style="margin: 2px; padding: 5px; background: #333; color: #0f0; border: 1px solid #0f0;">Test Typewriter</button>
      <button onclick="testAudio()" style="margin: 2px; padding: 5px; background: #333; color: #0f0; border: 1px solid #0f0;">Test Audio</button>
      <button onclick="testSequence()" style="margin: 2px; padding: 5px; background: #333; color: #0f0; border: 1px solid #0f0;">Test Sequence</button>
      <div id="debug-info" style="color: #0f0; margin-top: 10px; font-family: monospace; font-size: 12px;">
        <div>
          Step: <span id="debug-step">0</span>
        </div>
        <div>
          Status: <span id="debug-status">Ready</span>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script src="{% static 'dialogue/js/boh_dialogue.js' %}"></script>

  <script>
    // Auto-start dialogue when page loads
    document.addEventListener('DOMContentLoaded', function () {
      // Small delay to ensure everything is loaded
      setTimeout(() => {
        if (window.bohDialogue) {
          bohDialogue.initDialogue()
        }
      }, 500)
    })
  </script>

  {% if settings.DEBUG %}
    <script>
      // Test functions for debug mode
      function testBasicText() {
        if (window.bohDialogue) {
          bohDialogue.typeText('Teste de texto básico funcionando!')
          document.getElementById('debug-status').textContent = 'Testing text'
        }
      }
      
      function testTypewriter() {
        if (window.bohDialogue) {
          bohDialogue.typeText('Este é um teste de efeito typewriter com velocidade controlada.', 80)
          document.getElementById('debug-status').textContent = 'Testing typewriter'
        }
      }
      
      function testAudio() {
        if (window.bohDialogue) {
          bohDialogue.playTypingSound()
          document.getElementById('debug-status').textContent = 'Testing audio'
        }
      }
      
      function testSequence() {
        if (window.bohDialogue) {
          bohDialogue.reset()
          bohDialogue.initDialogue()
          document.getElementById('debug-status').textContent = 'Testing sequence'
        }
      }
      
      // Update debug info periodically
      setInterval(() => {
        if (window.bohDialogue) {
          document.getElementById('debug-step').textContent = bohDialogue.currentStep
      
          let status = 'Ready'
          if (bohDialogue.isTyping) status = 'Typing'
          else if (bohDialogue.isPaused) status = 'Paused'
          else if (bohDialogue.isWaitingForResponse) status = 'Waiting for response'
          else if (bohDialogue.isWaitingForName) status = 'Waiting for name'
      
          document.getElementById('debug-status').textContent = status
        }
      }, 1000)
      
      function log(message) {
        console.log(new Date().toLocaleTimeString() + ': ' + message)
      }
    </script>
  {% endif %}

  <script>
    // Sound toggle
    function toggleSound() {
      if (window.bohDialogue) {
        bohDialogue.soundEnabled = !bohDialogue.soundEnabled
        const indicator = document.getElementById('sound-indicator')
        if (indicator) {
          indicator.textContent = bohDialogue.soundEnabled ? '🔊' : '🔇'
        }
    
        const toggleBtn = document.getElementById('toggle-sound')
        if (toggleBtn) {
          toggleBtn.textContent = bohDialogue.soundEnabled ? '🔊' : '🔇'
        }
      }
    }
    
    // Setup sound controls
    document.addEventListener('DOMContentLoaded', function () {
      const toggleBtn = document.getElementById('toggle-sound')
      if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleSound)
      }
    })
    
    // Global keyboard shortcuts
    document.addEventListener('keydown', function (e) {
      // Ctrl+R to reset dialogue
      if (e.ctrlKey && e.key === 'r' && window.bohDialogue) {
        e.preventDefault()
        bohDialogue.reset()
        bohDialogue.initDialogue()
      }
    
      // Ctrl+M to toggle sound
      if (e.ctrlKey && e.key === 'm') {
        e.preventDefault()
        toggleSound()
      }
    })
  </script>
{% endblock %}
