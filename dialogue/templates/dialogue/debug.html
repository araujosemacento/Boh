{% extends 'dialogue/base.html' %}
{% load static %}

{% block content %}
  <div class="boh-display">
    <div class="expression" id="boh-expression">[ ▀ ¸ ▀]</div>
    <div class="dialogue-container">
      <span class="dialogue-prefix">──┤</span>
      <span class="dialogue-text" id="dialogue-text">Carregando...</span>
      <span class="dialogue-suffix">│</span>
    </div>
  </div>

  <div id="debug-info" style="color: #0f0; margin-top: 20px; font-family: monospace;">
    <h3>Informações de Debug:</h3>
    <div id="debug-messages"></div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    function log(message) {
      const debugDiv = document.getElementById('debug-messages')
      debugDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>'
      console.log(message)
    }
    
    function testBOHDialogue() {
      log('Iniciando teste da classe BOHDialogue...')
    
      try {
        // Testar se a classe pode ser instanciada
        const testClass = `
              class TestBOH {
                constructor() {
                  this.expressions = {
                    idle: ['[ ▀ ¸ ▀]', '[ ▀ ° ▀]']
                  };
                  this.soundEnabled = true;
                  this.sounds = [];
                  this.isTyping = false;
                  this.isPaused = false;
                  this.waitingForSpacePress = false;
                }
                
                async typeText(text) {
                  document.getElementById('dialogue-text').innerHTML = text;
                  return Promise.resolve();
                }
              }
            `
    
        eval(testClass)
        const testInstance = new TestBOH()
        log('✓ Classe de teste criada com sucesso')
    
        // Testar audio
        const audio = document.createElement('audio')
        audio.volume = 0.5
        log('✓ Elemento de áudio criado')
    
        // Testar localStorage
        localStorage.setItem('test', 'value')
        const stored = localStorage.getItem('test')
        localStorage.removeItem('test')
        log('✓ LocalStorage funcionando: ' + stored)
    
        // Testar Promise
        new Promise((resolve) => {
          setTimeout(() => {
            resolve('success')
            log('✓ Promises funcionando')
          }, 100)
        })
    
        // Testar async/await
        ;(async () => {
          await new Promise((resolve) => setTimeout(resolve, 200))
          log('✓ Async/await funcionando')
    
          // Tentar carregar BOHDialogue real
          try {
            if (typeof BOHDialogue !== 'undefined') {
              log('✓ Classe BOHDialogue encontrada')
              const realInstance = new BOHDialogue()
              log('✓ BOHDialogue instanciada com sucesso')
            } else {
              log('✗ Classe BOHDialogue não encontrada')
              // Tentar carregar o script principal
              fetch('/static/dialogue/js/main.js')
                .then(() => log('✓ Script principal carregado'))
                .catch(() => log('✗ Erro ao carregar script principal'))
            }
          } catch (error) {
            log('✗ Erro ao instanciar BOHDialogue: ' + error.message)
          }
        })()
      } catch (error) {
        log('✗ Erro no teste: ' + error.message)
      }
    }
    
    document.addEventListener('DOMContentLoaded', function () {
      log('DOM carregado')
      testBOHDialogue()
    })
  </script>
{% endblock %}
